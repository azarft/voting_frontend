# Voting System API Documentation

Данная документация содержит подробное описание MVP бэкенда системы голосования, построенного на Spring Boot с использованием событийно-ориентированной архитектуры.

## 1. Технологический стек
- **Java 21**
- **Spring Boot 3.4.2** (Web, Security, Data JPA, AMQP, Mail, Cache, Validation)
- **PostgreSQL 16** (Основная БД)
- **RabbitMQ 3** (Брокер сообщений для обработки голосов)
- **Caffeine Cache** (Кэширование результатов в памяти)
- **Flyway** (Миграции БД)
- **Docker & Docker Compose** (Контейнеризация)

---

## 2. Безопасность и Аутентификация

### Passwordless Authentication
Система использует беспарольную аутентификацию через Email:
1. Пользователь вводит email.
2. Система генерирует 6-значный код и отправляет его на почту (через Google SMTP).
3. Пользователь вводит код.
4. После успешной проверки система выдает JWT токен.

**Ограничение:** Разрешены только email адреса домена `@alatoo.edu.kg`.

### Роли
- `ADMIN`: Управление сессиями (создание, активация).
- `USER`: Право на один голос в каждой активной сессии.

**Предустановленный администратор:**
- Email: `argen.azanov@alatoo.edu.kg`

### CORS (Cross-Origin Resource Sharing)
В системе настроен CORS, разрешающий запросы со всех источников (`*`). Это позволяет фронтенд-приложениям на любых доменах взаимодействовать с API. Разрешены все стандартные HTTP-методы и заголовки, включая экспорт заголовка `Authorization`.

---

## 3. Эндпоинты API

### 3.1. Аутентификация (Публично)

#### Запрос кода верификации
Отправляет 6-значный код на указанный email.
- **URL:** `/auth/request-code`
- **Метод:** `POST`
- **Тело запроса:**
  ```json
  {
    "email": "student@alatoo.edu.kg"
  }
  ```
- **Успешный ответ (200 OK):** `Verification code sent to student@alatoo.edu.kg`
- **Ошибки:**
  - `400 Bad Request`: Неверный формат email или домен не `@alatoo.edu.kg`.

#### Проверка кода и получение токена
- **URL:** `/auth/verify-code`
- **Метод:** `POST`
- **Тело запроса:**
  ```json
  {
    "email": "student@alatoo.edu.kg",
    "code": "123456"
  }
  ```
- **Успешный ответ (200 OK):**
  ```json
  {
    "token": "eyJhbGciOiJIUzI1NiJ9..."
  }
  ```
- **Ошибки:**
  - `401 Unauthorized`: Код неверный или истек срок действия (5 минут).

---

### 3.2. Панель Администратора (Требуется роль ADMIN)
*Все запросы требуют заголовок `Authorization: Bearer <JWT_TOKEN>`*

#### Получение всех сессий
Возвращает список всех сессий в системе.
- **URL:** `/admin/session`
- **Метод:** `GET`
- **Успешный ответ (200 OK):** Список объектов сессий.

#### Получение деталей сессии
- **URL:** `/admin/session/{id}`
- **Метод:** `GET`
- **Успешный ответ (200 OK):** Объект сессии.

#### Создание сессии голосования
Создает новую сессию в статусе `DRAFT`.
- **URL:** `/admin/session`
- **Метод:** `POST`
- **Тело запроса:**
  ```json
  {
    "title": "Лучший язык программирования 2024",
    "options": ["Java", "Kotlin", "Go", "Python"]
  }
  ```
- **Успешный ответ (200 OK):** Объект созданной сессии с ID.

#### Активация сессии
Переводит сессию в статус `ACTIVE`. **Внимание:** Одновременно может быть активна только одна сессия. Активация новой сессии автоматически закрывает предыдущую активную.
- **URL:** `/admin/session/activate/{id}`
- **Метод:** `POST`
- **Успешный ответ (200 OK):** `Session 1 activated`

#### Закрытие сессии
Вручную переводит активную сессию в статус `CLOSED`.
- **URL:** `/admin/session/close/{id}`
- **Метод:** `POST`
- **Успешный ответ (200 OK):** `Session 1 closed`

#### Удаление сессии
Удаляет сессию. Нельзя удалить активную сессию (сначала нужно закрыть).
- **URL:** `/admin/session/{id}`
- **Метод:** `DELETE`
- **Успешный ответ (200 OK):** `Session 1 deleted`

---

### 3.3. Сессии и Голосование (Требуется роль USER)

#### Получение активной сессии (Публично)
- **URL:** `/session/active`
- **Метод:** `GET`
- **Успешный ответ (200 OK):**
  ```json
  {
    "id": 1,
    "title": "Лучший язык программирования 2024",
    "status": "ACTIVE",
    "options": [
      { "id": 1, "text": "Java" },
      { "id": 2, "text": "Kotlin" }
    ]
  }
  ```

#### Отправка голоса
- **URL:** `/vote`
- **Метод:** `POST`
- **Заголовок:** `Authorization: Bearer <JWT_TOKEN>`
- **Тело запроса:**
  ```json
  {
    "sessionId": 1,
    "optionId": 2
  }
  ```
- **Успешный ответ (200 OK):** `Vote submitted successfully`
- **Ошибки:**
  - `400 Bad Request`: Пользователь уже голосовал, сессия не активна или опция не принадлежит этой сессии.

---

### 3.4. Результаты (Публично)

#### Живые результаты (Live Results)
Возвращает текущее количество голосов для активной сессии. Данные берутся из кэша.
- **URL:** `/results/live`
- **Метод:** `GET`
- **Успешный ответ (200 OK):**
  ```json
  {
    "Java": 15,
    "Kotlin": 24
  }
  ```

#### Финальные результаты
Возвращает результаты для любой сессии по её ID (напрямую из БД).
- **URL:** `/results/final`
- **Метод:** `GET`
- **Параметры:** `sessionId=1`
- **Успешный ответ (200 OK):** Объект с результатами.

---

## 4. Архитектура и Внутренние механизмы

### Событийная модель (RabbitMQ)
Внутри монолита реализован паттерн Producer-Consumer:
1. При вызове `/vote` данные сохраняются в БД.
2. `VoteProducer` отправляет событие `VoteEvent` в Exchange `vote_exchange`.
3. `VoteConsumer` слушает очередь `vote_queue`, логирует событие и имитирует асинхронную обработку.
Это позволяет легко вынести обработку голосов в отдельный микросервис в будущем.

### Live Results и Кэширование
- Используется **Caffeine Cache**.
- Настроен **Scheduled Job**, который запускается каждые **2 секунды**.
- Задача пересчитывает голоса из БД для активной сессии и обновляет кэш.
- Эндпоинт `/results/live` всегда читает из кэша, что снижает нагрузку на БД при большом количестве запросов.

---

## 5. Инфраструктура и Запуск

### Docker Compose
Проект включает в себя:
- `voting-app`: Само приложение (Spring Boot).
- `voting-db`: PostgreSQL 16.
- `voting-rabbitmq`: RabbitMQ с Management UI.

### Запуск проекта
```bash
docker-compose up --build
```
- API доступно на: `http://localhost:8080`
- RabbitMQ UI: `http://localhost:15672` (guest/guest)

### Переменные окружения (application.yaml)
Основные настройки можно изменить через переменные среды в `docker-compose.yml`:
- `SPRING_DATASOURCE_URL`
- `SPRING_MAIL_USERNAME` / `SPRING_MAIL_PASSWORD` (Для отправки реальных кодов)
- `APP_JWT_SECRET`

---

## 6. Модели данных (Entities)

### User
- `id`: Long
- `email`: String (Unique)
- `role`: ADMIN, USER
- `verified`: Boolean

### VotingSession
- `id`: Long
- `title`: String
- `status`: DRAFT, ACTIVE, CLOSED
- `options`: List<Option>

### Option
- `id`: Long
- `text`: String
- `sessionId`: Long

### Vote
- `id`: Long
- `userId`: Long
- `sessionId`: Long
- `optionId`: Long
- `timestamp`: LocalDateTime
